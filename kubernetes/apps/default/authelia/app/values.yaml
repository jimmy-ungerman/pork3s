# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/common-3.0.1/charts/library/common/values.schema.json
controllers:
  main:
    replicas: 2
    strategy: RollingUpdate
    annotations:
      reloader.stakater.com/auto: "true"
    initContainers:
      init-db:
        image:
          repository: ghcr.io/onedr0p/postgres-init
          tag: 16.2
          pullPolicy: IfNotPresent
        envFrom: &envFrom
          - secretRef:
              name: authelia-secret
    containers:
      app:
        image:
          repository: ghcr.io/authelia/authelia
          tag: 4.38.8@sha256:19375b10024caeef4e0b119a6247beae84cbaa02c846cfd750e92dea910d4b6a
        env:
          AUTHELIA_SERVER_ADDRESS: tcp://0.0.0.0:80
          AUTHELIA_SERVER_DISABLE_HEALTHCHECK: "true"
          AUTHELIA_TELEMETRY_METRICS_ADDRESS: tcp://0.0.0.0:8080
          AUTHELIA_TELEMETRY_METRICS_ENABLED: "true"
          AUTHELIA_THEME: dark
          X_AUTHELIA_CONFIG: /app/configuration.yaml
          X_AUTHELIA_CONFIG_FILTERS: expand-env
        envFrom: *envFrom
        probes:
          liveness: &probes
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /api/health
                port: &port 80
              initialDelaySeconds: 0
              periodSeconds: 10
              timeoutSeconds: 1
              failureThreshold: 3
          readiness: *probes
        resources:
          requests:
            cpu: 10m
            memory: 32Mi
          limits:
            memory: 128Mi
    pod:
      enableServiceLinks: false
      securityContext:
        runAsUser: 568
        runAsGroup: 568
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: authelia
service:
  app:
    controller: main
    ports:
      http:
        port: *port
      metrics:
        port: 8080
serviceMonitor:
  app:
    enabled: true
    serviceName: app
    endpoints:
      - port: metrics
        scheme: http
        path: /metrics
        interval: 1m
        scrapeTimeout: 10s
ingress:
  app:
    className: nginx
    annotations:
      external-dns.alpha.kubernetes.io/target: porkboi.io
      external-dns.alpha.kubernetes.io/hostname: auth.porkboi.io
      nginx.ingress.kubernetes.io/configuration-snippet: |
        add_header Cache-Control "no-store";
        add_header Pragma "no-cache";
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-XSS-Protection "1; mode=block";
    hosts:
      - host: &host auth.porkboi.io
        paths:
          - path: /
            service:
              identifier: app
              port: http
    tls:
      - hosts:
          - *host
persistence:
  config:
    enabled: true
    type: configMap
    name: authelia-configmap
    globalMounts:
      - path: /app/configuration.yaml
        subPath: configuration.yaml
        readOnly: true